<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT æ°´è³ªé æ¸¬ç›£æ§ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å…¨åŸŸè¨­å®š */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ä¸Šæ–¹æ¨™é ­å¡ç‰‡ */
        .header-card { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; position: relative;}
        .header-title { display: flex; align-items: center; justify-content: center; gap: 10px; color: #2c3e50; }
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .select-container { position: absolute; right: 30px; top: 30px; text-align: left; }
        .select-container label { display: block; font-size: 0.8em; color: #7f8c8d; margin-bottom: 5px; }
        select { padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; outline: none; background: #fff; cursor: pointer; }
        select:hover { border-color: #3498db; }

        /* æ•¸å€¼é¡¯ç¤ºå€ */
        .value-display { margin-top: 20px; }
        .main-value { font-size: 4em; font-weight: bold; color: #2ecc71; margin: 10px 0; transition: color 0.3s; }
        .sub-text { color: #7f8c8d; font-size: 1.1em; }
        .loading-bar { width: 50px; height: 4px; background: #2ecc71; margin: 0 auto; animation: pulse 1s infinite; }
        
        /* ä¸‹æ–¹åœ–è¡¨èˆ‡åˆ—è¡¨å€å¡Š */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); height: 400px; overflow-y: auto; }
        h3 { margin-top: 0; color: #34495e; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; margin-bottom: 15px; }

        /* ç‰¹å¾µåˆ—è¡¨æ¨£å¼ */
        .feature-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 15px 10px; 
            border-bottom: 1px solid #eee; 
            transition: background 0.2s;
        }
        .feature-row:last-child { border-bottom: none; }
        .feature-row:hover { background-color: #f9f9f9; }
        
        .feat-name { font-size: 1.1em; font-weight: 600; color: #555; }
        .feat-val { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 0.8em; color: #999; margin-left: 5px; font-weight: normal; }

        @keyframes pulse { 0% { opacity: 0.5; width: 50px; } 50% { opacity: 1; width: 70px; } 100% { opacity: 0.5; width: 50px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="select-container">
            <label>é¸æ“‡é æ¸¬ç›®æ¨™æ¨¡å‹ï¼š</label>
            <select id="targetSelect" onchange="switchTarget()">
                <option value="NH4_1209">NH4_1209 (æ°¨æ°®)</option>
                <option value="RPI_1208">RPI_1208 (æ²³å·æ±¡æŸ“æŒ‡æ•¸)</option>
                <option value="SS_1206">SS_1206 (æ‡¸æµ®å›ºé«”)</option>
            </select>
        </div>

        <div class="header-title">
            <h2>ğŸŒŠ æ°´è³ªé æ¸¬ç›£æ§ (RFECV Testing Data)</h2>
        </div>
        
        <div class="value-display">
            <div id="loadingLine" class="loading-bar"></div>
            <div id="predValue" class="main-value">--</div>
            <div class="sub-text">ç•¶å‰é æ¸¬å€¼ (<span id="targetUnitDisplay">mg/L</span>)</div>
            <div id="timeLabel" style="color: #bdc3c7; font-size: 0.9em; margin-top: 5px;">ç­‰å¾…é€£ç·šä¸­...</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="card">
            <h3>ğŸ“ˆ é æ¸¬è¶¨å‹¢ (Time Series)</h3>
            <div style="height: 320px;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ§ª Top 5 å½±éŸ¿ç‰¹å¾µ (å³æ™‚æ•¸å€¼)</h3>
            <div id="featureList">
                <div style="text-align:center; color:#ccc; margin-top: 50px;">ç­‰å¾…æ•¸æ“šä¸­...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // â˜…â˜…â˜… è«‹ä¿®æ”¹é€™è£¡ï¼šå¡«å…¥æ‚¨çš„ API Ngrok ç¶²å€ â˜…â˜…â˜…
    // ==========================================
    const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; // æ³¨æ„ï¼šå¾Œé¢ä¸è¦æœ‰æ–œç·š

    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'é æ¸¬æ•¸å€¼', 
                data: [], 
                borderColor: '#3498db', 
                borderWidth: 2, 
                tension: 0.4, 
                fill: true, 
                backgroundColor: 'rgba(52, 152, 219, 0.05)' 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { x: { display: false }, y: { beginAtZero: false } }, 
            plugins: { legend: { display: false } },
            animation: false 
        }
    });

    let lastTimestamp = "";

    // â˜… 1. åˆ¤æ–·ç‰¹å¾µ (å°é …ç›®) çš„å–®ä½
    function getFeatureUnit(name) {
        const n = name.toUpperCase();
        if (n.includes("EC") || n.includes("COND")) return "Î¼S/cm";
        if (n.includes("PH")) return "";
        if (n.includes("TEMP") || n.includes("WT")) return "Â°C";
        if (n.includes("TURB")) return "NTU";
        return "mg/L";
    }

    // â˜… 2. åˆ¤æ–·ç›®æ¨™ (å¤§æ¨™é¡Œ) çš„å–®ä½
    function getTargetUnit(targetName) {
        const t = targetName.toUpperCase();
        // å¦‚æœæ˜¯ RPI (æŒ‡æ•¸)ï¼Œé€šå¸¸æ²’æœ‰å–®ä½æˆ–ç¨±ç‚º "Score"
        if (t.includes("RPI")) return "Index"; 
        // å¦‚æœæ˜¯å°é›»åº¦
        if (t.includes("EC")) return "Î¼S/cm";
        // å¦‚æœæ˜¯æ¿åº¦
        if (t.includes("TURBIDITY")) return "NTU";
        // é è¨­ (NH4, SS, COD, BOD éƒ½æ˜¯ mg/L)
        return "mg/L";
    }

    async function switchTarget() {
        const select = document.getElementById('targetSelect');
        const newTarget = select.value;
        
        try {
            await fetch(`${API_BASE}/api/config/set_target`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({ target_name: newTarget })
            });
            
            lineChart.data.labels = [];
            lineChart.data.datasets[0].data = [];
            lineChart.update();
            document.getElementById('featureList').innerHTML = '<div style="text-align:center;color:#ccc;margin-top:50px;">ğŸ”„ æ¨¡å‹åˆ‡æ›ä¸­...</div>';
            document.getElementById('predValue').innerText = "--";
            document.getElementById('predValue').style.color = "#ccc";
            
            // â˜… åˆ‡æ›æ™‚é †ä¾¿æ›´æ–°å–®ä½é¡¯ç¤º (çµ¦ä½¿ç”¨è€…ç«‹å³å›é¥‹)
            document.getElementById('targetUnitDisplay').innerText = getTargetUnit(newTarget);

            console.log("å·²åˆ‡æ›è‡³:", newTarget);
        } catch (e) {
            console.error("åˆ‡æ›å¤±æ•—", e);
            alert("åˆ‡æ›å¤±æ•—ï¼Œè«‹ç¢ºèª API é€£ç·šæ˜¯å¦æ­£å¸¸");
        }
    }

    async function updateDashboard() {
        try {
            const res = await fetch(`${API_BASE}/api/dashboard/monitor`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            });
            const data = await res.json();

            if (data.timestamp === "Waiting..." || data.timestamp === lastTimestamp) return;
            lastTimestamp = data.timestamp;

            // æ›´æ–°æ•¸å€¼
            document.getElementById('predValue').innerText = data.value.toFixed(4);
            document.getElementById('predValue').style.color = "#2ecc71";
            document.getElementById('timeLabel').innerText = "æœ€å¾Œæ›´æ–°: " + data.timestamp;
            document.getElementById('loadingLine').style.display = 'none';
            
            // â˜… æ”¶åˆ°æ•¸æ“šå¾Œï¼Œå†æ¬¡ç¢ºèªä¸¦æ›´æ–°å¤§æ¨™é¡Œçš„å–®ä½
            document.getElementById('targetUnitDisplay').innerText = getTargetUnit(data.target);

            const select = document.getElementById('targetSelect');
            if (select.value !== data.target && data.target !== "--") {
                select.value = data.target;
            }

            lineChart.data.labels.push(data.timestamp);
            lineChart.data.datasets[0].data.push(data.value);
            if (lineChart.data.labels.length > 20) {
                lineChart.data.labels.shift();
                lineChart.data.datasets[0].data.shift();
            }
            lineChart.update();

            const listContainer = document.getElementById('featureList');
            listContainer.innerHTML = ""; 
            
            const features = data.top_features;
            
            for (const [name, value] of Object.entries(features)) {
                const unit = getFeatureUnit(name); 
                const row = document.createElement('div');
                row.className = 'feature-row';
                row.innerHTML = `
                    <div class="feat-name">${name}</div>
                    <div class="feat-val">
                        ${value.toFixed(2)}<span class="unit">${unit}</span>
                    </div>
                `;
                listContainer.appendChild(row);
            }

        } catch (e) {
            console.error("é€£ç·šéŒ¯èª¤", e);
            document.getElementById('timeLabel').innerText = "é€£ç·šä¸­æ–·...";
        }
    }

    setInterval(updateDashboard, 1000);
</script>
</body>
</html>