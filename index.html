<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT æ™ºæ…§æ°´è³ªæˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* æ¨™é ­ */
        .header-card { grid-column: 1 / -1; background: white; border-radius: 12px; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header-left h2 { margin: 0; color: #1a73e8; display: flex; align-items: center; gap: 10px; }
        .header-right { text-align: right; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        h3 { margin-top: 0; color: #444; border-bottom: 2px solid #f1f3f4; padding-bottom: 10px; font-size: 1.1em; display: flex; justify-content: space-between; }
        
        /* æ•¸å€¼é¡¯ç¤º */
        .main-value { font-size: 3.5em; font-weight: 800; color: #34a853; margin: 5px 0; }
        .unit-label { font-size: 0.4em; color: #888; font-weight: normal; }
        .status-badge { background: #e6f4ea; color: #1e8e3e; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }

        /* â˜… SHAP åˆ—è¡¨æ¨£å¼ (ä¿æŒæ‚¨åŸæœ¬çš„æ¨£å­) â˜… */
        .feature-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 15px 10px; 
            border-bottom: 1px solid #eee; 
            transition: background 0.2s;
        }
        .feature-row:last-child { border-bottom: none; }
        .feature-row:hover { background-color: #f9f9f9; }
        .feat-name { font-size: 1.1em; font-weight: 600; color: #555; }
        .feat-val { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 0.8em; color: #999; margin-left: 5px; font-weight: normal; }

        /* è¼¸å…¥æ§åˆ¶é … */
        select, input[type="date"], button { padding: 8px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; outline: none; }
        button { background: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #1557b0; }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-box { position: relative; height: 250px; width: 100%; }
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; color: #666; font-weight: bold; z-index: 10; display: none; flex-direction: column; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-left">
            <h2>ğŸŒŠ AIoT æ™ºæ…§æ°´è³ªæˆ°æƒ…å®¤</h2>
            <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                ç›£æ§ç›®æ¨™ï¼š
                <select id="targetSelect" onchange="switchTarget()" style="font-weight: bold; color: #1a73e8;">
                    <option value="NH4_1209">NH4_1209 (æ°¨æ°®)</option>
                    <option value="RPI_1208">RPI_1208 (æ²³å·æ±¡æŸ“æŒ‡æ•¸)</option>
                    <option value="SS_1206">SS_1206 (æ‡¸æµ®å›ºé«”)</option>
                </select>
            </div>
        </div>
        <div class="header-right">
            <div id="predValue" class="main-value">-- <span class="unit-label" id="unitDisplay">mg/L</span></div>
            <div class="status-badge">ğŸŸ¢ ç³»çµ±é‹ä½œæ­£å¸¸ | æ›´æ–°æ–¼ <span id="timeLabel">--</span></div>
        </div>
    </div>

    <div class="card" style="grid-column: 1 / 2;">
        <h3>ğŸ“ˆ å³æ™‚ç›£æ§è¶¨å‹¢ <small style="color: #888; font-weight: normal; font-size: 0.8em;">(é»æ“ŠæŠ˜ç·šåœ–ä»¥åŸ·è¡Œ LIME)</small></h3>
        <div style="height: 320px;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card" style="grid-column: 2 / 3;">
        <h3>ğŸ§ª Top 5 å½±éŸ¿ç‰¹å¾µ (å³æ™‚æ•¸å€¼)</h3>
        <div id="featureList" style="height: 320px; overflow-y: auto;">
            <div style="text-align: center; color: #999; margin-top: 50px;">ç­‰å¾…æ•¸æ“šä¸²æµ...</div>
        </div>
    </div>

    <div class="card" style="grid-column: 1 / 2;">
        <h3>
            ğŸ” LIME å–®é»æ·±åº¦è¨ºæ–·
            <span id="limeTimestamp" style="font-size: 0.8em; color: #1a73e8;">(è«‹é»æ“Šä¸Šæ–¹åœ–è¡¨)</span>
        </h3>
        <div class="chart-box">
            <div id="limeLoading" class="loading-overlay">
                <span>âš¡ åˆ†æé‹ç®—ä¸­...</span>
                <small style="color:#999; margin-top:5px;">(éœ€æ™‚ç´„ 2-5 ç§’)</small>
            </div>
            <canvas id="limeChart"></canvas>
        </div>
    </div>

    <div class="card" style="grid-column: 2 / 3;">
        <h3>ğŸ“… PI é•·æœŸæ¬Šé‡åˆ†æ</h3>
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="date" id="piStart" value="2018-01-01" style="width: 110px;">
            <input type="date" id="piEnd" value="2018-06-30" style="width: 110px;">
            <button onclick="runPI()">åˆ†æ</button>
        </div>
        <div class="chart-box">
            <div id="piLoading" class="loading-overlay">
                <span>ğŸ“Š å¤§æ•¸æ“šè¨ˆç®—ä¸­...</span>
            </div>
            <canvas id="piChart"></canvas>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // â˜…â˜…â˜… è«‹ä¿®æ”¹é€™è£¡ï¼šå¡«å…¥ API Ngrok ç¶²å€ â˜…â˜…â˜…
    // ==========================================
    const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; // æ³¨æ„ï¼šå¾Œé¢ä¸è¦æœ‰æ–œç·š

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentTarget = "NH4_1209";
    let lastTime = "";
    
    // Chart å¯¦ä¾‹
    let mainChartInstance = null;
    let limeChartInstance = null;
    let piChartInstance = null;

    // --- è¼”åŠ©å‡½å¼ï¼šåˆ¤æ–·å–®ä½ ---
    function getUnit(name) {
        if (!name) return "";
        const n = name.toUpperCase();
        if (n.includes("EC") || n.includes("COND")) return "Î¼S/cm";
        if (n.includes("PH")) return "";
        if (n.includes("TEMP") || n.includes("WT")) return "Â°C";
        if (n.includes("TURB")) return "NTU";
        return "mg/L";
    }
    
    function getTargetUnit(targetName) {
        const t = targetName.toUpperCase();
        if (t.includes("RPI")) return "Index"; 
        if (t.includes("EC")) return "Î¼S/cm";
        return "mg/L";
    }

    // --- åˆå§‹åŒ–ä¸»åœ–è¡¨ ---
    function initMainChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        mainChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'é æ¸¬å€¼', data: [], borderColor: '#1a73e8', borderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(26, 115, 232, 0.1)', pointRadius: 3, pointHoverRadius: 6 }] },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                onClick: handleChartClick, // ç¶å®šé»æ“Š
                plugins: { legend: { display: false } },
                scales: { x: { display: false } }
            }
        });
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 1: å³æ™‚ç›£æ§ (SHAP ä¿æŒåˆ—è¡¨) ---
    async function updateDashboard() {
        try {
            const res = await fetch(`${API_BASE}/api/dashboard/monitor`, { headers: {"ngrok-skip-browser-warning": "true"} });
            const data = await res.json();

            if(data.timestamp === "Waiting..." || data.timestamp === lastTime) return;
            lastTime = data.timestamp;

            // 1. æ›´æ–°æ•¸å€¼
            document.getElementById('predValue').innerHTML = `${data.value.toFixed(2)} <span class="unit-label" id="targetUnitDisplay">${getTargetUnit(data.target)}</span>`;
            document.getElementById('timeLabel').innerText = data.timestamp;
            
            // 2. æ›´æ–°æŠ˜ç·šåœ–
            const chart = mainChartInstance;
            chart.data.labels.push(data.timestamp);
            chart.data.datasets[0].data.push(data.value);
            if(chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update('none'); 

            // 3. æ›´æ–° SHAP åˆ—è¡¨ (â˜… é€™è£¡ä¿æŒæ‚¨è¦çš„åˆ—è¡¨æ¨£å¼ â˜…)
            const listContainer = document.getElementById('featureList');
            listContainer.innerHTML = ""; 
            
            for (const [name, value] of Object.entries(data.top_features)) {
                const unit = getUnit(name); 
                const row = document.createElement('div');
                row.className = 'feature-row';
                row.innerHTML = `
                    <div class="feat-name">${name}</div>
                    <div class="feat-val">
                        ${value.toFixed(2)}<span class="unit">${unit}</span>
                    </div>
                `;
                listContainer.appendChild(row);
            }

        } catch(e) { console.error("Monitor Error", e); }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 2: LIME åœ–è¡¨ (æ”¹ç‚º Chart) ---
    function handleChartClick(evt, elements) {
        if (elements.length === 0) return;
        
        const idx = elements[0].index;
        const timestamp = mainChartInstance.data.labels[idx];
        
        document.getElementById('limeLoading').style.display = 'flex'; 
        document.getElementById('limeTimestamp').innerText = `(${timestamp})`;

        fetch(`${API_BASE}/api/analysis/request`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({ type: "LIME", target_name: currentTarget, params: { timestamp: timestamp } })
        })
        .then(res => res.json())
        .then(data => pollResult(data.task_id, 'LIME'));
    }

    function renderLimeChart(data) {
        const ctx = document.getElementById('limeChart').getContext('2d');
        if (limeChartInstance) limeChartInstance.destroy(); 

        const labels = Object.keys(data.features);
        const values = Object.values(data.features);
        const colors = values.map(v => v >= 0 ? '#34a853' : '#ea4335'); // ç¶ æ­£ç´…è² 

        limeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å½±éŸ¿æ¬Šé‡',
                    data: values,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', // æ°´å¹³é•·æ¢åœ–
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'LIME ç‰¹å¾µè²¢ç»åº¦ (æ­£/è² å½±éŸ¿)' } },
                scales: { x: { grid: { color: '#f0f0f0' } }, y: { grid: { display: false } } }
            }
        });
        document.getElementById('limeLoading').style.display = 'none';
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 3: PI åœ–è¡¨ (æ”¹ç‚º Chart) ---
    function runPI() {
        const start = document.getElementById('piStart').value;
        const end = document.getElementById('piEnd').value;
        document.getElementById('piLoading').style.display = 'flex';

        fetch(`${API_BASE}/api/analysis/request`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({ type: "PI", target_name: currentTarget, params: { start: start, end: end } })
        })
        .then(res => res.json())
        .then(data => pollResult(data.task_id, 'PI'));
    }

    function renderPiChart(data) {
        const ctx = document.getElementById('piChart').getContext('2d');
        if (piChartInstance) piChartInstance.destroy();

        // æ’åº
        const sorted = Object.entries(data.features).sort(([,a], [,b]) => b - a);
        const labels = sorted.map(x => x[0]);
        const values = sorted.map(x => x[1]);

        piChartInstance = new Chart(ctx, {
            type: 'bar', // å‚ç›´é•·æ¢åœ–
            data: {
                labels: labels,
                datasets: [{
                    label: 'é‡è¦æ€§åˆ†æ•¸',
                    data: values,
                    backgroundColor: '#fbbc04', 
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'PI ç‰¹å¾µé‡è¦æ€§æ’è¡Œ (è¶Šé«˜è¶Šé‡è¦)' } },
                scales: { y: { beginAtZero: true } }
            }
        });
        document.getElementById('piLoading').style.display = 'none';
    }

    // --- é€šç”¨ï¼šè¼ªè©¢çµæœ ---
    function pollResult(taskId, type) {
        const interval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/api/analysis/result/${taskId}`, { headers: {"ngrok-skip-browser-warning": "true"} });
                const json = await res.json();
                
                if (json.status === "completed") {
                    clearInterval(interval);
                    if(type === 'LIME') renderLimeChart(json.data);
                    if(type === 'PI') renderPiChart(json.data);
                }
            } catch(e) { clearInterval(interval); }
        }, 1000);
    }

    // --- åˆ‡æ›ç›®æ¨™ ---
    async function switchTarget() {
        const val = document.getElementById('targetSelect').value;
        currentTarget = val;
        await fetch(`${API_BASE}/api/config/set_target`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({ target_name: val })
        });
        
        mainChartInstance.data.labels = [];
        mainChartInstance.data.datasets[0].data = [];
        mainChartInstance.update();
        document.getElementById('predValue').innerText = "--";
        
        // æ›´æ–°å¤§å–®ä½
        document.getElementById('targetUnitDisplay').innerText = getTargetUnit(val);
    }

    initMainChart();
    setInterval(updateDashboard, 1000);
</script>
</body>
</html>