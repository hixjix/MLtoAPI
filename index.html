<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§æ°´è³ªé æ¸¬ç³»çµ± (RFECVæ•´åˆç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; color: #2c3e50; }
        
        select { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }

        .metric-box { text-align: center; margin: 20px 0; }
        .metric-value { font-size: 3em; font-weight: bold; color: #27ae60; }
        .metric-label { color: #7f8c8d; font-size: 1.2em; }

        .charts-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .chart-container { flex: 1; min-width: 300px; height: 300px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <header>
            <h2>ğŸŒŠ æ°´è³ªé æ¸¬ç›£æ§ (RFECV Testing Data)</h2>
            <div>
                <label>é¸æ“‡é æ¸¬ç›®æ¨™ï¼š</label>
                <select id="targetSelect" onchange="switchTarget()">
                    <option value="Loading">è¼‰å…¥ä¸­...</option>
                </select>
            </div>
        </header>
        <div class="metric-box">
            <div id="predValue" class="metric-value">--</div>
            <div class="metric-label">ç•¶å‰é æ¸¬å€¼ (mg/L)</div>
            <div id="timestamp" style="font-size: 0.8em; color: #ccc; margin-top: 5px;">Wait...</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="card chart-container">
            <h3>ğŸ“ˆ é æ¸¬è¶¨å‹¢ (Time Series)</h3>
            <canvas id="lineChart"></canvas>
        </div>
        <div class="card chart-container">
            <h3>ğŸ§ª Top 5 å½±éŸ¿ç‰¹å¾µ (æ•¸å€¼)</h3>
            <canvas id="barChart"></canvas>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; 
    
    // åˆå§‹åŒ–åœ–è¡¨
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'é æ¸¬æ¿ƒåº¦', data: [], borderColor: '#3498db', tension: 0.4, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false } } }
    });

    const barCtx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ç‰¹å¾µæ•¸å€¼', data: [], backgroundColor: ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#1abc9c'] }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
    });

    // ç‹€æ…‹è®Šæ•¸
    let currentTarget = "";
    let isInit = false;

    async function fetchData() {
        try {
            const res = await fetch(`${API_URL}/api/dashboard/monitor`);
            const data = await res.json();

            // 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–® (åªåšä¸€æ¬¡)
            if (!isInit && data.available_targets.length > 0) {
                const select = document.getElementById('targetSelect');
                select.innerHTML = "";
                data.available_targets.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.text = t;
                    select.add(opt);
                });
                select.value = data.target;
                currentTarget = data.target;
                isInit = true;
            }

            // 2. æ›´æ–°æ•¸å€¼é¡¯ç¤º
            document.getElementById('predValue').innerText = data.value;
            document.getElementById('timestamp').innerText = "æœ€å¾Œæ›´æ–°: " + data.timestamp;

            // 3. æ›´æ–°æŠ˜ç·šåœ– (å¦‚æœæ™‚é–“æˆ³è¨˜è®Šäº†)
            const lastLabel = lineChart.data.labels.slice(-1)[0];
            if (lastLabel !== data.timestamp) {
                lineChart.data.labels.push(data.timestamp);
                lineChart.data.datasets[0].data.push(data.value);
                if (lineChart.data.labels.length > 20) {
                    lineChart.data.labels.shift();
                    lineChart.data.datasets[0].data.shift();
                }
                lineChart.update();

                // 4. æ›´æ–°é•·æ¢åœ– (Top 5 ç‰¹å¾µ)
                const feats = data.top_features;
                barChart.data.labels = Object.keys(feats);
                barChart.data.datasets[0].data = Object.values(feats);
                barChart.update();
            }

        } catch (e) {
            console.error("APIé€£ç·šå¤±æ•—", e);
        }
    }

    async function switchTarget() {
        const select = document.getElementById('targetSelect');
        const newTarget = select.value;
        
        // å‘¼å« API åˆ‡æ›æ¨¡å‹
        await fetch(`${API_URL}/api/config/set_target`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ target_name: newTarget })
        });

        // æ¸…ç©ºåœ–è¡¨
        lineChart.data.labels = [];
        lineChart.data.datasets[0].data = [];
        lineChart.update();
        alert(`å·²åˆ‡æ›è‡³ ${newTarget}ï¼Œæ¸¬è©¦æ•¸æ“šé‡ç½®ä¸­...`);
    }

    // æ¯ 5 ç§’æ›´æ–° (ä¾æ“šä½ çš„éœ€æ±‚)
    setInterval(fetchData, 1000); // å‰ç«¯æ¯ç§’ pollingï¼Œä½†å¾Œç«¯æ•¸æ“šæ˜¯æ¯ 5 ç§’ç”¢ç”Ÿä¸€ç­†
</script>

</body>
</html>