<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT æ™ºæ…§æ°´è³ªåˆ†æå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script> <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* æ¨™é ­è·¨æ¬„ */
        .header-card { grid-column: 1 / -1; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; position: relative;}
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        
        h3 { color: #2c3e50; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-top: 0; font-size: 1.1em; }
        
        /* æ•¸å€¼é¡¯ç¤º */
        .main-value { font-size: 3.5em; font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .sub-text { color: #7f8c8d; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .feature-row { display: flex; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .feat-name { font-weight: 600; color: #555; }
        .feat-val { font-weight: bold; color: #2c3e50; }
        
        /* è¼¸å…¥æ§åˆ¶é … */
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; }
        select, input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* åˆ†æçµæœå€ */
        .analysis-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e0; margin-top: 10px; min-height: 100px; }
        .loading { text-align: center; color: #999; padding: 20px; }
        .tag { display: inline-block; background: #e1f5fe; color: #0288d1; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div style="position: absolute; right: 25px; top: 25px; width: 200px;">
            <select id="targetSelect" onchange="switchTarget()">
                <option value="NH4_1209">NH4_1209 (æ°¨æ°®)</option>
                <option value="RPI_1208">RPI_1208 (æ²³å·æ±¡æŸ“æŒ‡æ•¸)</option>
                <option value="SS_1206">SS_1206 (æ‡¸æµ®å›ºé«”)</option>
            </select>
        </div>
        <h2>ğŸŒŠ AIoT æ™ºæ…§æ°´è³ªåˆ†æå¹³å°</h2>
        <div class="main-value" id="predValue">--</div>
        <div class="sub-text">å³æ™‚é æ¸¬å€¼ (<span id="unitDisplay">mg/L</span>) | æ›´æ–°æ–¼: <span id="timeLabel">--</span></div>
    </div>

    <div class="card" style="height: 400px;">
        <h3>ğŸ“ˆ å³æ™‚ç›£æ§è¶¨å‹¢ (é»æ“Šåœ–è¡¨ä»¥åŸ·è¡Œ LIME åˆ†æ)</h3>
        <canvas id="lineChart"></canvas>
    </div>

    <div class="card" style="overflow-y: auto; height: 400px;">
        <h3>âš¡ å³æ™‚å½±éŸ¿å› å­ (SHAP Top 5)</h3>
        <div id="shapList">
            <div class="loading">ç­‰å¾…æ•¸æ“š...</div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ” LIME å–®é»æ·±åº¦è¨ºæ–·</h3>
        <div class="analysis-box" id="limeResult">
            <div class="loading">è«‹é»æ“Šä¸Šæ–¹æŠ˜ç·šåœ–çš„ä»»ä¸€é»ä»¥é€²è¡Œåˆ†æ</div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“… PI å€é–“é‡è¦æ€§åˆ†æ</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="date" id="piStart" value="2018-01-01">
            <input type="date" id="piEnd" value="2018-06-30">
            <button onclick="runPI()" style="width: auto;">åŸ·è¡Œåˆ†æ</button>
        </div>
        <div class="analysis-box" id="piResult">
            <div class="loading">é¸æ“‡æ—¥æœŸç¯„åœå¾Œé»æ“ŠåŸ·è¡Œ</div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // â˜…â˜…â˜… è«‹ä¿®æ”¹é€™è£¡ï¼šå¡«å…¥ API Ngrok ç¶²å€ â˜…â˜…â˜…
    // ==========================================
    const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; 

    // --- åˆå§‹åŒ–åœ–è¡¨ ---
    const ctx = document.getElementById('lineChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'é æ¸¬å€¼', data: [], borderColor: '#3498db', tension: 0.4, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            onClick: handleChartClick, // â˜… ç¶å®šé»æ“Šäº‹ä»¶
            interaction: { mode: 'nearest', intersect: true },
            plugins: { legend: { display: false } }
        }
    });

    let currentTarget = "NH4_1209";
    let lastTime = "";

    // --- è¼”åŠ©å‡½å¼ ---
    function getUnit(name) {
        if (name.includes("EC")) return "Î¼S/cm";
        if (name.includes("PH")) return "";
        if (name.includes("TEMP")) return "Â°C";
        return "mg/L";
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 1: å®šæ™‚æ›´æ–° (SHAP) ---
    async function updateDashboard() {
        try {
            const res = await fetch(`${API_BASE}/api/dashboard/monitor`, { headers: {"ngrok-skip-browser-warning": "true"} });
            const data = await res.json();

            if(data.timestamp === "Waiting..." || data.timestamp === lastTime) return;
            lastTime = data.timestamp;

            // æ›´æ–°æ•¸å€¼
            document.getElementById('predValue').innerText = data.value.toFixed(2);
            document.getElementById('timeLabel').innerText = data.timestamp;
            
            // æ›´æ–°åœ–è¡¨
            chart.data.labels.push(data.timestamp);
            chart.data.datasets[0].data.push(data.value);
            if(chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update('none'); // 'none' æ¨¡å¼é¿å…å‹•ç•«å¹²æ“¾é»æ“Š

            // æ›´æ–° SHAP åˆ—è¡¨
            const list = document.getElementById('shapList');
            list.innerHTML = "";
            for (const [k, v] of Object.entries(data.top_features)) {
                list.innerHTML += `
                    <div class="feature-row">
                        <span class="feat-name">${k}</span>
                        <span class="feat-val">${v.toFixed(2)} <small>${getUnit(k)}</small></span>
                    </div>`;
            }
        } catch(e) { console.error("Monitor Error", e); }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 2: åˆ‡æ›ç›®æ¨™ ---
    async function switchTarget() {
        const val = document.getElementById('targetSelect').value;
        currentTarget = val;
        await fetch(`${API_BASE}/api/config/set_target`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({ target_name: val })
        });
        // é‡ç½®ç•«é¢
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
        document.getElementById('predValue').innerText = "--";
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 3: LIME é»æ“Šåˆ†æ ---
    function handleChartClick(evt, elements) {
        if (elements.length === 0) return;
        
        const idx = elements[0].index;
        const timestamp = chart.data.labels[idx];
        
        document.getElementById('limeResult').innerHTML = `<div class="loading">æ­£åœ¨åˆ†æ ${timestamp} çš„ LIME è§£é‡‹...<br>(é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜)</div>`;
        
        // ç™¼é€ LIME è«‹æ±‚
        fetch(`${API_BASE}/api/analysis/request`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({
                type: "LIME",
                target_name: currentTarget,
                params: { timestamp: timestamp }
            })
        })
        .then(res => res.json())
        .then(data => pollResult(data.task_id, 'limeResult'));
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 4: PI å€é–“åˆ†æ ---
    function runPI() {
        const start = document.getElementById('piStart').value;
        const end = document.getElementById('piEnd').value;
        
        document.getElementById('piResult').innerHTML = `<div class="loading">æ­£åœ¨è¨ˆç®— ${start} è‡³ ${end} çš„ PI é‡è¦æ€§...</div>`;
        
        fetch(`${API_BASE}/api/analysis/request`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
            body: JSON.stringify({
                type: "PI",
                target_name: currentTarget,
                params: { start: start, end: end }
            })
        })
        .then(res => res.json())
        .then(data => pollResult(data.task_id, 'piResult'));
    }

    // --- é€šç”¨ï¼šè¼ªè©¢çµæœ (Polling) ---
    function pollResult(taskId, divId) {
        const interval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/api/analysis/result/${taskId}`, { headers: {"ngrok-skip-browser-warning": "true"} });
                const json = await res.json();
                
                if (json.status === "completed") {
                    clearInterval(interval);
                    renderAnalysisResult(json.data, divId);
                }
            } catch(e) {
                clearInterval(interval);
                document.getElementById(divId).innerText = "åˆ†æå¤±æ•—";
            }
        }, 1000); // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡
    }

    function renderAnalysisResult(data, divId) {
        const container = document.getElementById(divId);
        container.innerHTML = "";
        
        // é¡¯ç¤ºæ¨™é¡Œè³‡è¨Š
        if (data.timestamp) container.innerHTML += `<div style="margin-bottom:10px;"><strong>åˆ†ææ™‚é–“é»:</strong> ${data.timestamp}</div>`;
        if (data.range) container.innerHTML += `<div style="margin-bottom:10px;"><strong>åˆ†æå€é–“:</strong> ${data.range}</div>`;
        
        // é¡¯ç¤ºç‰¹å¾µæ¬Šé‡
        let html = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">';
        if (data.features) {
            // æ’åº
            const sorted = Object.entries(data.features).sort(([,a], [,b]) => Math.abs(b) - Math.abs(a));
            
            for (const [k, v] of sorted) {
                const barWidth = Math.min(Math.abs(v) * 100, 100); // ç°¡å–®è¦–è¦ºåŒ–
                const color = v > 0 ? '#e74c3c' : '#3498db'; // ç´…æ­£è—è² 
                html += `
                    <div style="background:white; padding:8px; border-radius:5px;">
                        <div style="font-size:0.9em; color:#666;">${k}</div>
                        <div style="font-weight:bold; color:${color}">${v.toFixed(4)}</div>
                        <div style="height:4px; background:#eee; margin-top:5px;">
                            <div style="height:100%; width:${barWidth}%; background:${color};"></div>
                        </div>
                    </div>`;
            }
        }
        html += '</div>';
        container.innerHTML += html;
    }

    setInterval(updateDashboard, 1000);
</script>
</body>
</html>