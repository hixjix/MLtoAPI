<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´è³ªé æ¸¬ç›£æ§ (RFECV Testing Data)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* é ‚éƒ¨å¡ç‰‡ */
        .header-card { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; position: relative;}
        .header-title { display: flex; align-items: center; justify-content: center; gap: 10px; color: #2c3e50; }
        .select-container { position: absolute; right: 30px; top: 30px; }
        select { padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; outline: none; }
        
        .value-display { margin-top: 20px; }
        .main-value { font-size: 4em; font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .sub-text { color: #7f8c8d; font-size: 1.1em; }
        .loading-bar { width: 50px; height: 4px; background: #2ecc71; margin: 0 auto; animation: pulse 1s infinite; }
        
        /* ä¸‹æ–¹åœ–è¡¨å€ */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); height: 400px; }
        h3 { margin-top: 0; color: #34495e; display: flex; align-items: center; gap: 10px; }

        @keyframes pulse { 0% { opacity: 0.5; width: 50px; } 50% { opacity: 1; width: 70px; } 100% { opacity: 0.5; width: 50px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="select-container">
            <label>é¸æ“‡é æ¸¬ç›®æ¨™ï¼š</label>
            <select id="targetSelect">
                <option value="default">è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        <div class="header-title">
            <h2>ğŸŒŠ æ°´è³ªé æ¸¬ç›£æ§ (RFECV Testing Data)</h2>
        </div>
        
        <div class="value-display">
            <div id="loadingLine" class="loading-bar"></div>
            <div id="predValue" class="main-value">--</div>
            <div class="sub-text">ç•¶å‰é æ¸¬å€¼ (mg/L)</div>
            <div id="timeLabel" style="color: #bdc3c7; font-size: 0.9em; margin-top: 5px;">Wait...</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>ğŸ“ˆ é æ¸¬è¶¨å‹¢ (Time Series)</h3>
            <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ğŸ§ª Top 5 å½±éŸ¿ç‰¹å¾µ (æ•¸å€¼)</h3>
            <canvas id="barChart"></canvas>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… è«‹ç¢ºèªé€™è£¡å¡«çš„æ˜¯æ–°ç‰ˆ API çš„ Ngrok ç¶²å€ (ä¸è¦æœ‰æ–œç·šçµå°¾) â˜…â˜…â˜…
    const API_BASE = "https://elidia-pharmacopoeial-perpendicularly.ngrok-free.dev"; 

    // åˆå§‹åŒ–åœ–è¡¨
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'é æ¸¬æ¿ƒåº¦', data: [], borderColor: '#3498db', borderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.05)' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { beginAtZero: false } }, plugins: { legend: { display: false } } }
    });

    const barCtx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ç‰¹å¾µæ•¸å€¼', data: [], backgroundColor: '#e74c3c', borderRadius: 5 }] },
        options: { indexAxis: 'x', responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    async function updateDashboard() {
        try {
            const res = await fetch(`${API_BASE}/api/dashboard/monitor`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            });
            const data = await res.json();

            // å¦‚æœé‚„åœ¨ç­‰å¾…æ•¸æ“š
            if (data.timestamp === "Waiting...") return;

            // 1. æ›´æ–°æ•¸å€¼èˆ‡ç›®æ¨™
            document.getElementById('predValue').innerText = data.value.toFixed(4);
            document.getElementById('timeLabel').innerText = "æœ€å¾Œæ›´æ–°: " + data.timestamp;
            document.getElementById('loadingLine').style.display = 'none';

            // æ›´æ–°ä¸‹æ‹‰é¸å–® (é¡¯ç¤ºç•¶å‰ç›®æ¨™)
            const select = document.getElementById('targetSelect');
            if (select.options[0].value === 'default') {
                select.innerHTML = `<option value="${data.target}">${data.target}</option>`;
            }

            // 2. æ›´æ–°æŠ˜ç·šåœ–
            const lastTime = lineChart.data.labels.slice(-1)[0];
            if (lastTime !== data.timestamp) {
                lineChart.data.labels.push(data.timestamp);
                lineChart.data.datasets[0].data.push(data.value);
                if (lineChart.data.labels.length > 20) { // åªä¿ç•™æœ€å¾Œ 20 ç­†
                    lineChart.data.labels.shift();
                    lineChart.data.datasets[0].data.shift();
                }
                lineChart.update();

                // 3. æ›´æ–° Bar Chart (Top 5 Features)
                // data.top_features æ˜¯ä¸€å€‹å­—å…¸ { "Temp": 25.5, "pH": 7.2 ... }
                const feats = data.top_features;
                barChart.data.labels = Object.keys(feats);
                barChart.data.datasets[0].data = Object.values(feats);
                barChart.update();
            }

        } catch (e) {
            console.error("é€£ç·šéŒ¯èª¤", e);
        }
    }

    // æ¯ 1 ç§’æª¢æŸ¥ä¸€æ¬¡ API æ›´æ–°
    setInterval(updateDashboard, 1000);
</script>
</body>
</html>